"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5570],{5570:(S,k,_)=>{_.r(k),_.d(k,{SocialLoginWeb:()=>b});var s=_(467),E=_(5083);let b=(()=>{class p extends E.E_{constructor(){var o;if(super(),this.googleClientId=null,this.appleClientId=null,this.googleScriptLoaded=!1,this.googleLoginType="online",this.appleScriptLoaded=!1,this.appleScriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js",this.GOOGLE_TOKEN_REQUEST_URL="https://www.googleapis.com/oauth2/v3/tokeninfo",this.facebookAppId=null,this.facebookScriptLoaded=!1,localStorage.getItem(p.OAUTH_STATE_KEY)){console.log("OAUTH_STATE_KEY found");const e=this.handleOAuthRedirect();e&&(null===(o=window.opener)||void 0===o||o.postMessage(Object.assign({type:"oauth-response"},e.result),window.location.origin),window.close())}}handleOAuthRedirect(){const o=new URL(window.location.href).searchParams,e=o.get("code");if(e&&o.has("scope"))return{provider:"google",result:{provider:"google",result:{serverAuthCode:e}}};const n=window.location.hash.substring(1);if(console.log("handleOAuthRedirect",window.location.hash),!n)return;console.log("handleOAuthRedirect ok");const t=new URLSearchParams(n),r=t.get("access_token"),i=t.get("id_token");if(r&&i){localStorage.removeItem(p.OAUTH_STATE_KEY);const l=this.parseJwt(i);return{provider:"google",result:{accessToken:{token:r},idToken:i,profile:{email:l.email||null,familyName:l.family_name||null,givenName:l.given_name||null,id:l.sub||null,name:l.name||null,imageUrl:l.picture||null}}}}return null}initialize(o){var e=this;return(0,s.A)(function*(){var n,t,r;!(null===(n=o.google)||void 0===n)&&n.webClientId&&(e.googleClientId=o.google.webClientId,o.google.mode&&(e.googleLoginType=o.google.mode),yield e.loadGoogleScript()),!(null===(t=o.apple)||void 0===t)&&t.clientId&&(e.appleClientId=o.apple.clientId,yield e.loadAppleScript()),null!==(r=o.facebook)&&void 0!==r&&r.appId&&(e.facebookAppId=o.facebook.appId,yield e.loadFacebookScript(),FB.init({appId:e.facebookAppId,version:"v17.0",xfbml:!0,cookie:!0}))})()}login(o){var e=this;return(0,s.A)(function*(){switch(o.provider){case"google":return e.loginWithGoogle(o.options);case"apple":return e.loginWithApple(o.options);case"facebook":return e.loginWithFacebook(o.options);default:throw new Error(`Login for ${o.provider} is not implemented on web`)}})()}logout(o){var e=this;return(0,s.A)(function*(){switch(o.provider){case"google":if("offline"===e.googleLoginType)return Promise.reject("Offline login doesn't store tokens. logout is not available");console.log("Google logout: Id token should be revoked on the client side if stored");const n=e.getGoogleState();if(!n)return;yield e.rawLogoutGoogle(n.accessToken);break;case"apple":console.log("Apple logout: Session should be managed on the client side");break;case"facebook":return new Promise(t=>{FB.logout(()=>t())});default:throw new Error(`Logout for ${o.provider} is not implemented`)}})()}accessTokenIsValid(o){var e=this;return(0,s.A)(function*(){const n=`${e.GOOGLE_TOKEN_REQUEST_URL}?access_token=${encodeURIComponent(o)}`;try{const t=yield fetch(n);if(!t.ok)return console.log(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response not successful. Status code: ${t.status}. Assuming that the token is not valid`),!1;const r=yield t.text();if(!r)throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`);let i;try{i=JSON.parse(r)}catch(c){throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${c}`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${c}`)}const l=i.expires_in;if(null==l)throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`);let a;try{if(a=parseInt(l,10),isNaN(a))throw new Error("'expires_in' is not a valid integer")}catch(c){throw console.error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${l} is not a valid integer. Error: ${c}`),new Error(`Invalid response from ${e.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${l} is not a valid integer. Error: ${c}`)}return a>5}catch(t){throw console.error(t),t}})()}idTokenValid(o){try{const e=this.parseJwt(o),n=Math.ceil(Date.now()/1e3)+5;return e.exp&&n<e.exp}catch{return!1}}rawLogoutGoogle(o,e=null){var n=this;return(0,s.A)(function*(){if(null===e&&(e=yield n.accessTokenIsValid(o)),!0===e)return new Promise((t,r)=>{try{google.accounts.oauth2.revoke(o,(0,s.A)(function*(){n.clearStateGoogle(),t()}))}catch(i){r(i)}});n.clearStateGoogle()})()}isLoggedIn(o){var e=this;return(0,s.A)(function*(){switch(o.provider){case"google":if("offline"===e.googleLoginType)return Promise.reject("Offline login doesn't store tokens. isLoggedIn is not available");const n=e.getGoogleState();if(!n)return{isLoggedIn:!1};try{const t=yield e.accessTokenIsValid(n.accessToken),r=e.idTokenValid(n.idToken);if(t&&r)return{isLoggedIn:!0};try{yield e.rawLogoutGoogle(n.accessToken,!1)}catch(i){console.error("Access token is not valid, but cannot logout",i)}return{isLoggedIn:!1}}catch(t){return Promise.reject(t)}case"apple":return console.log("Apple login status should be managed on the client side"),{isLoggedIn:!1};case"facebook":return new Promise(t=>{FB.getLoginStatus(r=>{t({isLoggedIn:"connected"===r.status})})});default:throw new Error(`isLoggedIn for ${o.provider} is not implemented`)}})()}getAuthorizationCode(o){var e=this;return(0,s.A)(function*(){switch(o.provider){case"google":if("offline"===e.googleLoginType)return Promise.reject("Offline login doesn't store tokens. getAuthorizationCode is not available");const n=e.getGoogleState();if(!n)throw new Error("No Google authorization code available");try{const t=yield e.accessTokenIsValid(n.accessToken),r=e.idTokenValid(n.idToken);if(t&&r)return{accessToken:n.accessToken,jwt:n.idToken};try{yield e.rawLogoutGoogle(n.accessToken,!1)}catch(i){console.error("Access token is not valid, but cannot logout",i)}throw new Error("No Google authorization code available")}catch(t){return Promise.reject(t)}case"apple":throw console.log("Apple authorization code should be stored during login"),new Error("Apple authorization code not available");case"facebook":return new Promise((t,r)=>{FB.getLoginStatus(i=>{var l;"connected"===i.status?t({jwt:(null===(l=i.authResponse)||void 0===l?void 0:l.accessToken)||""}):r(new Error("No Facebook authorization code available"))})});default:throw new Error(`getAuthorizationCode for ${o.provider} is not implemented`)}})()}refresh(o){var e=this;return(0,s.A)(function*(){switch(o.provider){case"google":return Promise.reject("Not implemented");case"apple":console.log("Apple refresh not available on web");break;case"facebook":yield e.loginWithFacebook(o.options);break;default:throw new Error(`Refresh for ${o.provider} is not implemented`)}})()}loginWithGoogle(o){if(!this.googleClientId)throw new Error("Google Client ID not set. Call initialize() first.");let e=o.scopes||[];return e.length>0?(e.includes("https://www.googleapis.com/auth/userinfo.email")||e.push("https://www.googleapis.com/auth/userinfo.email"),e.includes("https://www.googleapis.com/auth/userinfo.profile")||e.push("https://www.googleapis.com/auth/userinfo.profile"),e.includes("openid")||e.push("openid")):e=["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile","openid"],e.length>3||"offline"===this.googleLoginType||o.disableOneTap?this.fallbackToTraditionalOAuth(e):new Promise((n,t)=>{google.accounts.id.initialize({client_id:this.googleClientId,callback:r=>{if(console.log("google.accounts.id.initialize callback",r),r.error)t(r.error);else{const i=this.parseJwt(r.credential);n({provider:"google",result:{accessToken:null,responseType:"online",idToken:r.credential,profile:{email:i.email||null,familyName:i.family_name||null,givenName:i.given_name||null,id:i.sub||null,name:i.name||null,imageUrl:i.picture||null}}})}},auto_select:!0}),google.accounts.id.prompt(r=>{r.isNotDisplayed()||r.isSkippedMoment()?(console.log("OneTap is not displayed or skipped"),this.fallbackToTraditionalOAuth(e).then(i=>n({provider:"google",result:i.result})).catch(t)):console.log("OneTap is displayed")})})}parseJwt(o){const n=o.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent(atob(n).split("").map(r=>"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(t)}loadGoogleScript(){var o=this;return(0,s.A)(function*(){if(!o.googleScriptLoaded)return new Promise((e,n)=>{const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.async=!0,t.onload=()=>{o.googleScriptLoaded=!0,e()},t.onerror=n,document.body.appendChild(t)})})()}loginWithApple(o){var e=this;return(0,s.A)(function*(){if(!e.appleClientId)throw new Error("Apple Client ID not set. Call initialize() first.");if(!e.appleScriptLoaded)throw new Error("Apple Sign-In script not loaded.");return new Promise((n,t)=>{var r;AppleID.auth.init({clientId:e.appleClientId,scope:(null===(r=o.scopes)||void 0===r?void 0:r.join(" "))||"name email",redirectURI:o.redirectUrl||window.location.href,state:o.state,nonce:o.nonce,usePopup:!0}),AppleID.auth.signIn().then(i=>{var l,a,c,g,h,d,u;const f={profile:{user:null!==(a=null===(l=i.user)||void 0===l?void 0:l.name)&&void 0!==a&&a.firstName?`${i.user.name.firstName} ${i.user.name.lastName}`:"",email:(null===(c=i.user)||void 0===c?void 0:c.email)||null,givenName:(null===(h=null===(g=i.user)||void 0===g?void 0:g.name)||void 0===h?void 0:h.firstName)||null,familyName:(null===(u=null===(d=i.user)||void 0===d?void 0:d.name)||void 0===u?void 0:u.lastName)||null},accessToken:{token:i.authorization.code},idToken:i.authorization.id_token||null};n({provider:"apple",result:f})}).catch(i=>{t(i)})})})()}loadAppleScript(){var o=this;return(0,s.A)(function*(){if(!o.appleScriptLoaded)return new Promise((e,n)=>{const t=document.createElement("script");t.src=o.appleScriptUrl,t.async=!0,t.onload=()=>{o.appleScriptLoaded=!0,e()},t.onerror=n,document.body.appendChild(t)})})()}persistStateGoogle(o,e){try{window.localStorage.setItem("capgo_social_login_google_state",JSON.stringify({accessToken:o,idToken:e}))}catch(n){console.error("Cannot persist state google",n)}}clearStateGoogle(){try{window.localStorage.removeItem("capgo_social_login_google_state")}catch(o){console.error("Cannot clear state google",o)}}getGoogleState(){try{const o=window.localStorage.getItem("capgo_social_login_google_state");if(!o)return null;const{accessToken:e,idToken:n}=JSON.parse(o);return{accessToken:e,idToken:n}}catch(o){return console.error("Cannot get state google",o),null}}loadFacebookScript(){var o=this;return(0,s.A)(function*(){if(!o.facebookScriptLoaded)return new Promise((e,n)=>{const t=document.createElement("script");t.src="https://connect.facebook.net/en_US/sdk.js",t.async=!0,t.defer=!0,t.onload=()=>{o.facebookScriptLoaded=!0,e()},t.onerror=n,document.body.appendChild(t)})})()}loginWithFacebook(o){var e=this;return(0,s.A)(function*(){if(!e.facebookAppId)throw new Error("Facebook App ID not set. Call initialize() first.");return new Promise((n,t)=>{FB.login(r=>{"connected"===r.status?FB.api("/me",{fields:"id,name,email,picture"},i=>{var l,a;const c={accessToken:{token:r.authResponse.accessToken,userId:r.authResponse.userID},profile:{userID:i.id,name:i.name,email:i.email||null,imageURL:(null===(a=null===(l=i.picture)||void 0===l?void 0:l.data)||void 0===a?void 0:a.url)||null,friendIDs:[],birthday:null,ageRange:null,gender:null,location:null,hometown:null,profileURL:null},idToken:null};n({provider:"facebook",result:c})}):t(new Error("Facebook login failed"))},{scope:o.permissions.join(",")})})})()}fallbackToTraditionalOAuth(o){var e=this;return(0,s.A)(function*(){const n=[...new Set([...o,"openid"])],r=`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:e.googleClientId,redirect_uri:window.location.href,response_type:"offline"===e.googleLoginType?"code":"token id_token",scope:n.join(" "),nonce:Math.random().toString(36).substring(2),include_granted_scopes:"true",state:"popup"}).toString()}`,a=window.screenX+(window.outerWidth-500)/2,c=window.screenY+(window.outerHeight-600)/2;localStorage.setItem(p.OAUTH_STATE_KEY,"true");const g=window.open(r,"Google Sign In",`width=500,height=600,left=${a},top=${c},popup=1`);return new Promise((h,d)=>{if(!g)return void d(new Error("Failed to open popup"));const u=f=>{var T;if(f.origin===window.location.origin)if("oauth-response"===(null===(T=f.data)||void 0===T?void 0:T.type))if(window.removeEventListener("message",u),"online"===e.googleLoginType){const{accessToken:w,idToken:v}=f.data;if(w&&v){const m=e.parseJwt(v);e.persistStateGoogle(w.token,v),h({provider:"google",result:{accessToken:{token:w.token},idToken:v,profile:{email:m.email||null,familyName:m.family_name||null,givenName:m.given_name||null,id:m.sub||null,name:m.name||null,imageUrl:m.picture||null},responseType:"online"}})}}else{const{serverAuthCode:w}=f.data.result;h({provider:"google",result:{responseType:"offline",serverAuthCode:w}})}else d(new Error("Login failed"))};window.addEventListener("message",u),setTimeout(()=>{window.removeEventListener("message",u),g.close(),d(new Error("OAuth timeout"))},3e5)})})()}}return p.OAUTH_STATE_KEY="social_login_oauth_pending",p})()}}]);